<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代謝修復預約後台管理系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'M PLUS Rounded 1c', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e2e8f0;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* 頁首樣式 */
        .admin-header {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            padding: 25px 40px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .header-left h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .header-left p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .admin-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 10px 25px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        /* 統計卡片樣式 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: inline-block;
            padding: 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stat-info h3 {
            font-size: 1rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        
        .stat-info .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: #e2e8f0;
        }
        
        /* 篩選器樣式 */
        .filters-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .filters-section h3 {
            margin-bottom: 20px;
            color: #e2e8f0;
            font-size: 1.4rem;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-weight: 500;
        }
        
        .filter-select, .filter-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .filter-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .filter-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-btn.primary {
            background: linear-gradient(to right, #3b82f6, #0ea5e9);
            color: white;
        }
        
        .filter-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }
        
        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        /* 預約表格樣式 */
        .appointments-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .section-header h3 {
            font-size: 1.4rem;
            color: #e2e8f0;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
        }
        
        .appointments-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        .appointments-table th {
            background: rgba(255, 255, 255, 0.08);
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            color: #94a3b8;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .appointments-table td {
            padding: 18px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .appointments-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }
        
        .status-confirmed {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }
        
        .status-cancelled {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }
        
        .status-completed {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .action-btn.view {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }
        
        .action-btn.edit {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }
        
        .action-btn.delete {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        /* 詳情彈窗樣式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: #1e293b;
            border-radius: 20px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .detail-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .detail-group h4 {
            color: #94a3b8;
            margin-bottom: 15px;
            font-size: 1.1rem;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .detail-item {
            margin-bottom: 12px;
        }
        
        .detail-label {
            font-weight: 600;
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #e2e8f0;
            font-size: 1rem;
        }
        
        .modal-footer {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .header-left h1 {
                font-size: 1.8rem;
            }
            
            .section-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .filter-actions {
                flex-direction: column;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* 空狀態樣式 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #475569;
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #e2e8f0;
        }
        
        .empty-state p {
            color: #94a3b8;
            margin-bottom: 30px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* 導出按鈕樣式 */
        .export-btn {
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- 頁首 -->
        <div class="admin-header">
            <div class="header-left">
                <h1>代謝修復預約後台管理系統</h1>
                <p>查看和管理所有預約申請</p>
            </div>
            <div class="admin-badge">
                <i class="fas fa-lock"></i> 管理員模式
            </div>
        </div>
        
        <!-- 統計卡片 -->
        <div class="stats-grid" id="statsGrid">
            <!-- 統計卡片將由JavaScript動態生成 -->
        </div>
        
        <!-- 篩選器 -->
        <div class="filters-section">
            <h3>篩選預約</h3>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="filterStatus">狀態篩選</label>
                    <select id="filterStatus" class="filter-select">
                        <option value="">全部狀態</option>
                        <option value="pending_confirmation">待確認</option>
                        <option value="confirmed">已確認</option>
                        <option value="completed">已完成</option>
                        <option value="cancelled">已取消</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterDate">預約日期</label>
                    <input type="date" id="filterDate" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="filterSearch">關鍵字搜尋</label>
                    <input type="text" id="filterSearch" class="filter-input" placeholder="搜尋姓名、電話、Email...">
                </div>
            </div>
            <div class="filter-actions">
                <button class="filter-btn primary" id="applyFilters">
                    <i class="fas fa-filter"></i> 套用篩選
                </button>
                <button class="filter-btn secondary" id="clearFilters">
                    <i class="fas fa-redo"></i> 清除篩選
                </button>
                <button class="export-btn" id="exportData">
                    <i class="fas fa-download"></i> 匯出資料
                </button>
            </div>
        </div>
        
        <!-- 預約表格 -->
        <div class="appointments-section">
            <div class="section-header">
                <h3>預約列表</h3>
                <div class="table-info" id="tableInfo">
                    <!-- 表格資訊將由JavaScript動態生成 -->
                </div>
            </div>
            
            <div class="table-container">
                <table class="appointments-table" id="appointmentsTable">
                    <thead>
                        <tr>
                            <th>預約編號</th>
                            <th>姓名</th>
                            <th>聯絡方式</th>
                            <th>預約日期</th>
                            <th>狀態</th>
                            <th>提交時間</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentsTableBody">
                        <!-- 表格內容將由JavaScript動態生成 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 空狀態 -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-clipboard-list"></i>
                <h3>暫無預約資料</h3>
                <p>目前沒有任何預約申請，或者您的篩選條件沒有匹配的結果。</p>
                <button class="filter-btn primary" id="resetEmptyFilters">
                    <i class="fas fa-redo"></i> 顯示所有預約
                </button>
            </div>
        </div>
    </div>
    
    <!-- 詳情彈窗 -->
    <div class="modal-overlay" id="detailModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>預約詳情</h2>
                <button class="close-modal" id="closeDetailModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 詳情內容將由JavaScript動態生成 -->
            </div>
            <div class="modal-footer">
                <div class="status-control">
                    <label for="statusSelect">更新狀態:</label>
                    <select id="statusSelect" class="filter-select" style="width: auto; margin-left: 10px;">
                        <option value="pending_confirmation">待確認</option>
                        <option value="confirmed">已確認</option>
                        <option value="completed">已完成</option>
                        <option value="cancelled">已取消</option>
                    </select>
                </div>
                <div>
                    <button class="filter-btn secondary" id="updateStatus">
                        <i class="fas fa-save"></i> 更新狀態
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局變量
        let appointments = [];
        let filteredAppointments = [];
        let currentAppointmentId = null;
        
        // DOM 加載完成
        document.addEventListener('DOMContentLoaded', function() {
            // 載入預約數據
            loadAppointments();
            
            // 綁定事件監聽器
            setupEventListeners();
            
            // 初始化頁面
            updateStats();
            renderAppointmentsTable();
        });
        
        // 載入預約數據
        function loadAppointments() {
            const storedAppointments = localStorage.getItem('metabolic_appointments');
            if (storedAppointments) {
                appointments = JSON.parse(storedAppointments);
                filteredAppointments = [...appointments];
                console.log(`載入 ${appointments.length} 筆預約資料`);
            } else {
                appointments = [];
                filteredAppointments = [];
                console.log('暫無預約資料');
            }
        }
        
        // 綁定事件監聽器
        function setupEventListeners() {
            // 篩選按鈕
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            
            // 匯出資料按鈕
            document.getElementById('exportData').addEventListener('click', exportData);
            
            // 空狀態重置按鈕
            document.getElementById('resetEmptyFilters').addEventListener('click', clearFilters);
            
            // 關閉詳情彈窗
            document.getElementById('closeDetailModal').addEventListener('click', closeDetailModal);
            
            // 更新狀態按鈕
            document.getElementById('updateStatus').addEventListener('click', updateAppointmentStatus);
            
            // 點擊彈窗外部關閉
            document.getElementById('detailModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeDetailModal();
                }
            });
            
            // 按ESC鍵關閉彈窗
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeDetailModal();
                }
            });
        }
        
        // 更新統計卡片
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            
            const stats = {
                total: appointments.length,
                pending: appointments.filter(a => a.status === 'pending_confirmation').length,
                confirmed: appointments.filter(a => a.status === 'confirmed').length,
                completed: appointments.filter(a => a.status === 'completed').length,
                cancelled: appointments.filter(a => a.status === 'cancelled').length
            };
            
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-icon" style="color: #3b82f6;">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3>總預約數</h3>
                        <div class="stat-number">${stats.total}</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="color: #f59e0b;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3>待確認</h3>
                        <div class="stat-number">${stats.pending}</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="color: #10b981;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>已確認</h3>
                        <div class="stat-number">${stats.confirmed}</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="color: #ef4444;">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>已取消</h3>
                        <div class="stat-number">${stats.cancelled}</div>
                    </div>
                </div>
            `;
            
            statsGrid.innerHTML = statsHTML;
        }
        
        // 套用篩選
        function applyFilters() {
            const statusFilter = document.getElementById('filterStatus').value;
            const dateFilter = document.getElementById('filterDate').value;
            const searchFilter = document.getElementById('filterSearch').value.toLowerCase();
            
            filteredAppointments = appointments.filter(appointment => {
                // 狀態篩選
                if (statusFilter && appointment.status !== statusFilter) {
                    return false;
                }
                
                // 日期篩選
                if (dateFilter && appointment.preferredDate !== dateFilter) {
                    return false;
                }
                
                // 關鍵字搜尋
                if (searchFilter) {
                    const searchText = `${appointment.igName || ''} ${appointment.email || ''} ${appointment.phone || ''} ${appointment.id || ''}`.toLowerCase();
                    if (!searchText.includes(searchFilter)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            renderAppointmentsTable();
        }
        
        // 清除篩選
        function clearFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDate').value = '';
            document.getElementById('filterSearch').value = '';
            
            filteredAppointments = [...appointments];
            renderAppointmentsTable();
        }
        
        // 渲染預約表格
        function renderAppointmentsTable() {
            const tableBody = document.getElementById('appointmentsTableBody');
            const emptyState = document.getElementById('emptyState');
            const tableInfo = document.getElementById('tableInfo');
            
            // 更新表格資訊
            tableInfo.textContent = `顯示 ${filteredAppointments.length} 筆資料中的 ${Math.min(filteredAppointments.length, 50)} 筆`;
            
            // 檢查是否有資料
            if (filteredAppointments.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                document.querySelector('.table-container').style.display = 'none';
                return;
            }
            
            // 隱藏空狀態，顯示表格
            emptyState.style.display = 'none';
            document.querySelector('.table-container').style.display = 'block';
            
            // 排序：最新的在前
            const sortedAppointments = [...filteredAppointments].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            
            // 限制顯示數量
            const displayAppointments = sortedAppointments.slice(0, 50);
            
            // 生成表格內容
            let tableHTML = '';
            
            displayAppointments.forEach(appointment => {
                // 格式化日期
                const appointmentDate = appointment.preferredDate ? 
                    new Date(appointment.preferredDate).toLocaleDateString('zh-TW') : '未提供';
                
                const submitDate = new Date(appointment.timestamp).toLocaleString('zh-TW');
                
                // 狀態標籤
                let statusBadge = '';
                let statusText = '';
                
                switch (appointment.status) {
                    case 'pending_confirmation':
                        statusBadge = 'status-pending';
                        statusText = '待確認';
                        break;
                    case 'confirmed':
                        statusBadge = 'status-confirmed';
                        statusText = '已確認';
                        break;
                    case 'completed':
                        statusBadge = 'status-completed';
                        statusText = '已完成';
                        break;
                    case 'cancelled':
                        statusBadge = 'status-cancelled';
                        statusText = '已取消';
                        break;
                    default:
                        statusBadge = 'status-pending';
                        statusText = '待確認';
                }
                
                tableHTML += `
                    <tr>
                        <td><strong>${appointment.id || '未提供'}</strong></td>
                        <td>${appointment.igName || '未提供'}</td>
                        <td>
                            <div>${appointment.email || '未提供'}</div>
                            <div style="font-size: 0.9rem; color: #94a3b8;">${appointment.phone || '未提供'}</div>
                        </td>
                        <td>${appointmentDate}</td>
                        <td><span class="status-badge ${statusBadge}">${statusText}</span></td>
                        <td>${submitDate}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="viewAppointmentDetail('${appointment.id}')">
                                    <i class="fas fa-eye"></i> 查看
                                </button>
                                <button class="action-btn delete" onclick="deleteAppointment('${appointment.id}')">
                                    <i class="fas fa-trash"></i> 刪除
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }
        
        // 查看預約詳情
        function viewAppointmentDetail(appointmentId) {
            const appointment = appointments.find(a => a.id === appointmentId);
            if (!appointment) return;
            
            currentAppointmentId = appointmentId;
            
            // 設置狀態選擇
            document.getElementById('statusSelect').value = appointment.status || 'pending_confirmation';
            
            // 格式化日期
            const appointmentDate = appointment.preferredDate ? 
                new Date(appointment.preferredDate).toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                }) : '未提供';
            
            const submitDate = new Date(appointment.timestamp).toLocaleString('zh-TW');
            
            // 生成詳情HTML
            const detailHTML = `
                <div class="detail-grid">
                    <div class="detail-group">
                        <h4>基本資訊</h4>
                        <div class="detail-item">
                            <div class="detail-label">預約編號</div>
                            <div class="detail-value">${appointment.id || '未提供'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">提交時間</div>
                            <div class="detail-value">${submitDate}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">當前狀態</div>
                            <div class="detail-value">
                                <span class="status-badge ${getStatusClass(appointment.status)}">
                                    ${getStatusText(appointment.status)}
                                </span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">郵件發送</div>
                            <div class="detail-value">
                                ${appointment.emailSent ? 
                                    '<span style="color: #10b981;">✓ 已發送</span>' : 
                                    '<span style="color: #ef4444;">✗ 未發送</span>'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-group">
                        <h4>聯絡資訊</h4>
                        <div class="detail-item">
                            <div class="detail-label">Instagram 用戶名</div>
                            <div class="detail-value">${appointment.igName || '未提供'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">電子郵箱</div>
                            <div class="detail-value">${appointment.email || '未提供'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">聯絡電話</div>
                            <div class="detail-value">${appointment.phone || '未提供'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">年齡確認</div>
                            <div class="detail-value">${appointment.age || '未提供'}</div>
                        </div>
                    </div>
                    
                    <div class="detail-group">
                        <h4>預約時間</h4>
                        <div class="detail-item">
                            <div class="detail-label">首選日期</div>
                            <div class="detail-value">${appointmentDate}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">首選時間</div>
                            <div class="detail-value">${appointment.timePreferences ? appointment.timePreferences.join(', ') : '未選擇'}</div>
                        </div>
                    </div>
                    
                    <div class="detail-group">
                        <h4>代謝數據</h4>
                        <div class="detail-item">
                            <div class="detail-label">性別/年齡/身高</div>
                            <div class="detail-value">
                                ${appointment.gender || '未提供'} / 
                                ${appointment.ageNum || '未提供'}歲 / 
                                ${appointment.height || '未提供'}cm
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">體重/腰圍</div>
                            <div class="detail-value">
                                ${appointment.weight || '未提供'}kg / 
                                ${appointment.waist || '未提供'}cm
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">職業/活動水平</div>
                            <div class="detail-value">${appointment.occupation || '未提供'}</div>
                        </div>
                    </div>
                    
                    <div class="detail-group">
                        <h4>代謝問題與目標</h4>
                        <div class="detail-item">
                            <div class="detail-label">當前問題</div>
                            <div class="detail-value">${appointment.problem ? appointment.problem.substring(0, 100) + (appointment.problem.length > 100 ? '...' : '') : '未提供'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">已嘗試方法</div>
                            <div class="detail-value">${appointment.attempts ? appointment.attempts.substring(0, 100) + (appointment.attempts.length > 100 ? '...' : '') : '未提供'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">主要目標</div>
                            <div class="detail-value">${appointment.goal || '未提供'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">投資意願</div>
                            <div class="detail-value">${appointment.investment || '未提供'}</div>
                        </div>
                    </div>
                    
                    ${appointment.additionalInfo ? `
                    <div class="detail-group">
                        <h4>補充資訊</h4>
                        <div class="detail-item">
                            <div class="detail-value">${appointment.additionalInfo}</div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('modalBody').innerHTML = detailHTML;
            document.getElementById('detailModal').style.display = 'flex';
        }
        
        // 獲取狀態類別
        function getStatusClass(status) {
            switch (status) {
                case 'pending_confirmation': return 'status-pending';
                case 'confirmed': return 'status-confirmed';
                case 'completed': return 'status-completed';
                case 'cancelled': return 'status-cancelled';
                default: return 'status-pending';
            }
        }
        
        // 獲取狀態文字
        function getStatusText(status) {
            switch (status) {
                case 'pending_confirmation': return '待確認';
                case 'confirmed': return '已確認';
                case 'completed': return '已完成';
                case 'cancelled': return '已取消';
                default: return '待確認';
            }
        }
        
        // 關閉詳情彈窗
        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        // 更新預約狀態
        function updateAppointmentStatus() {
            if (!currentAppointmentId) return;
            
            const newStatus = document.getElementById('statusSelect').value;
            const appointmentIndex = appointments.findIndex(a => a.id === currentAppointmentId);
            
            if (appointmentIndex !== -1) {
                appointments[appointmentIndex].status = newStatus;
                
                // 更新本地存儲
                localStorage.setItem('metabolic_appointments', JSON.stringify(appointments));
                
                // 更新篩選後的列表
                const filteredIndex = filteredAppointments.findIndex(a => a.id === currentAppointmentId);
                if (filteredIndex !== -1) {
                    filteredAppointments[filteredIndex].status = newStatus;
                }
                
                // 更新UI
                updateStats();
                renderAppointmentsTable();
                
                // 重新載入詳情
                viewAppointmentDetail(currentAppointmentId);
                
                alert('狀態更新成功！');
            }
        }
        
        // 刪除預約
        function deleteAppointment(appointmentId) {
            if (!confirm('確定要刪除此預約嗎？此操作無法復原。')) {
                return;
            }
            
            // 從所有列表中刪除
            appointments = appointments.filter(a => a.id !== appointmentId);
            filteredAppointments = filteredAppointments.filter(a => a.id !== appointmentId);
            
            // 更新本地存儲
            localStorage.setItem('metabolic_appointments', JSON.stringify(appointments));
            
            // 更新UI
            updateStats();
            renderAppointmentsTable();
            
            alert('預約已刪除！');
        }
        
        // 匯出資料
        function exportData() {
            if (appointments.length === 0) {
                alert('暫無資料可匯出');
                return;
            }
            
            // 創建CSV內容
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // 添加標題行
            const headers = [
                "預約編號", "姓名", "Email", "電話", "年齡確認", 
                "性別", "年齡", "身高(cm)", "體重(kg)", "腰圍(cm)", "職業",
                "預約日期", "首選時間", "代謝問題", "已嘗試方法", "飲食結構",
                "飲食偏好", "目標", "決心", "投資意願", "補充資訊",
                "狀態", "提交時間", "郵件發送"
            ];
            csvContent += headers.join(",") + "\n";
            
            // 添加數據行
            appointments.forEach(appointment => {
                const row = [
                    `"${appointment.id || ''}"`,
                    `"${appointment.igName || ''}"`,
                    `"${appointment.email || ''}"`,
                    `"${appointment.phone || ''}"`,
                    `"${appointment.age || ''}"`,
                    `"${appointment.gender || ''}"`,
                    `"${appointment.ageNum || ''}"`,
                    `"${appointment.height || ''}"`,
                    `"${appointment.weight || ''}"`,
                    `"${appointment.waist || ''}"`,
                    `"${appointment.occupation || ''}"`,
                    `"${appointment.preferredDate || ''}"`,
                    `"${appointment.timePreferences ? appointment.timePreferences.join('; ') : ''}"`,
                    `"${(appointment.problem || '').replace(/"/g, '""')}"`,
                    `"${(appointment.attempts || '').replace(/"/g, '""')}"`,
                    `"${(appointment.diet || '').replace(/"/g, '""')}"`,
                    `"${appointment.dietPreferences ? appointment.dietPreferences.join('; ') : ''}"`,
                    `"${(appointment.goal || '').replace(/"/g, '""')}"`,
                    `"${appointment.commitment || ''}"`,
                    `"${appointment.investment || ''}"`,
                    `"${(appointment.additionalInfo || '').replace(/"/g, '""')}"`,
                    `"${getStatusText(appointment.status)}"`,
                    `"${new Date(appointment.timestamp).toLocaleString('zh-TW')}"`,
                    `"${appointment.emailSent ? '是' : '否'}"`
                ];
                csvContent += row.join(",") + "\n";
            });
            
            // 創建下載連結
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `代謝修復預約_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            
            // 觸發下載
            link.click();
            document.body.removeChild(link);
        }
        
        // 初始化一些示例數據（如果沒有數據）
        function initializeSampleData() {
            if (appointments.length === 0) {
                const sampleAppointments = [
                    {
                        id: "MET2601121001",
                        igName: "sample_user1",
                        email: "sample1@example.com",
                        phone: "0912345678",
                        age: "是，已滿23歲",
                        gender: "女",
                        ageNum: "28",
                        height: "165",
                        weight: "62",
                        waist: "75",
                        occupation: "辦公室久坐族",
                        problem: "減重遇到停滯期，體重已經2個月沒有變化",
                        attempts: "嘗試過168斷食和每週3次有氧運動，但效果不明顯",
                        diet: "早餐：不吃/午餐：外食便當/晚餐：家裡煮",
                        dietPreferences: ["外食為主", "飲食不規律"],
                        goal: "3個月內減重5kg，腰圍減少5cm",
                        commitment: "非常堅定",
                        investment: "願意投資",
                        preferredDate: "2026-01-15",
                        timePreferences: ["09:00-10:00", "14:00-15:00"],
                        additionalInfo: "有輕度甲狀腺問題",
                        understand: "我瞭解並同意",
                        status: "pending_confirmation",
                        emailSent: true,
                        timestamp: "2026-01-12T08:30:00.000Z"
                    },
                    {
                        id: "MET2601121002",
                        igName: "sample_user2",
                        email: "sample2@example.com",
                        phone: "0923456789",
                        age: "是，已滿23歲",
                        gender: "男",
                        ageNum: "35",
                        height: "178",
                        weight: "85",
                        waist: "92",
                        occupation: "健身教練",
                        problem: "增肌遇到瓶頸，肌肉量停滯",
                        attempts: "嘗試調整蛋白質攝取和訓練強度",
                        diet: "高蛋白飲食，一日五餐",
                        dietPreferences: ["自己烹飪"],
                        goal: "增加3kg純肌肉，降低體脂肪率",
                        commitment: "願意嘗試",
                        investment: "可能投資",
                        preferredDate: "2026-01-16",
                        timePreferences: ["19:00-20:00"],
                        additionalInfo: "",
                        understand: "我瞭解並同意",
                        status: "confirmed",
                        emailSent: true,
                        timestamp: "2026-01-12T10:15:00.000Z"
                    }
                ];
                
                appointments = sampleAppointments;
                filteredAppointments = [...appointments];
                localStorage.setItem('metabolic_appointments', JSON.stringify(appointments));
                
                console.log('已初始化示例數據');
                updateStats();
                renderAppointmentsTable();
            }
        }
        
        // 頁面載入完成後，如果沒有數據，可以選擇初始化示例數據
        // 取消下一行的註釋以啟用示例數據初始化
        // initializeSampleData();
    </script>
</body>
</html>
